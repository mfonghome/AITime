<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Hello World</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="card" role="main">
    <h1>Hello, World!</h1>
    <p class="subtitle">A tiny demo form with local storage.</p>

    <form id="helloForm" novalidate>
      <div class="form-row">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" required autocomplete="name" placeholder="Your name">
      </div>

      <div class="form-row">
        <label for="address">Address</label>
        <input id="address" name="address" type="text" required autocomplete="street-address" placeholder="Your address">
      </div>

      <div class="form-row">
        <label for="city">City</label>
        <input id="city" name="city" type="text" required autocomplete="address-level2" placeholder="Your city">
      </div>

      <div class="form-row">
        <label for="state">State</label>
        <input id="state" name="state" type="text" required autocomplete="address-level1" placeholder="Your state">
      </div>

      <div class="form-row">
        <label for="zip">ZIP Code</label>
        <input id="zip" name="zip" type="text" required autocomplete="postal-code" placeholder="ZIP code" pattern="\d{5}" maxlength="5">
      </div>

      <div class="buttons">
        <button type="submit">Submit</button>
        <button type="button" id="clearBtn">Clear</button>
      </div>
    </form>

    <div id="result" class="result" role="status" aria-live="polite"></div>

    <section class="saved">
      <div class="saved__header">
        <h2>Saved locally</h2>
        <div class="saved__actions">
          <button id="exportBtn" type="button" class="secondary">Export JSON</button>
          <button id="clearAllBtn" type="button" class="danger">Clear All</button>
        </div>
      </div>
      <div id="emptyMsg" class="muted">No saved entries yet.</div>
      <table id="savedTable" class="table" aria-label="Saved entries" hidden>
        <thead>
          <tr><th style="width:20%">Name</th><th style="width:30%">Address</th><th style="width:20%">City</th><th style="width:10%">State</th><th style="width:10%">ZIP</th><th style="width:10%">Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer class="footer">Â© mfonghome/AITime</footer>
  </main>

  <script>
    const STORAGE_KEY = 'aitime_submissions_v1';

    const form = document.getElementById('helloForm');
    const clearBtn = document.getElementById('clearBtn');
    const result = document.getElementById('result');
    const savedTable = document.getElementById('savedTable');
    const tbody = savedTable.querySelector('tbody');
    const emptyMsg = document.getElementById('emptyMsg');
    const exportBtn = document.getElementById('exportBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const cityInput = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const zipInput = document.getElementById('zip');

    function loadEntries() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveEntries(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    async function lookupZip(zip) {
      if (!/^\d{5}$/.test(zip)) {
        cityInput.value = '';
        stateInput.value = '';
        result.textContent = 'Please enter a valid 5-digit ZIP code.';
        return null;
      }

      try {
        const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
        if (!res.ok) throw new Error('Bad response');
        const data = await res.json();
        const place = data.places && data.places[0];
        if (place) {
          const city = place['place name'];
          const state = place['state abbreviation'];
          cityInput.value = city;
          stateInput.value = state;
          result.textContent = '';
          return { city, state };
        }
      } catch {
        // ignore errors
      }
      cityInput.value = '';
      stateInput.value = '';
      result.textContent = 'ZIP code not found.';
      return null;
    }

    function renderEntries() {
      const entries = loadEntries();
      tbody.innerHTML = '';

      if (!entries.length) {
        savedTable.hidden = true;
        emptyMsg.style.display = 'block';
        return;
      }

      savedTable.hidden = false;
      emptyMsg.style.display = 'none';

      entries.forEach((e, idx) => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        const tdAddr = document.createElement('td');
        const tdCity = document.createElement('td');
        const tdState = document.createElement('td');
        const tdZip = document.createElement('td');
        const tdAct = document.createElement('td');

        tdName.textContent = e.name;
        tdAddr.textContent = e.address;
        tdCity.textContent = e.city || '';
        tdState.textContent = e.state || '';
        tdZip.textContent = e.zip || '';

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'danger';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          const next = loadEntries();
          next.splice(idx, 1);
          saveEntries(next);
          renderEntries();
        });

        tdAct.appendChild(delBtn);
        tr.appendChild(tdName);
        tr.appendChild(tdAddr);
        tr.appendChild(tdCity);
        tr.appendChild(tdState);
        tr.appendChild(tdZip);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
    }

    zipInput.addEventListener('blur', () => lookupZip(zipInput.value.trim()));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      let city = cityInput.value.trim();
      let state = stateInput.value.trim();
      const zip = zipInput.value.trim();

      if (!/^\d{5}$/.test(zip)) {
        result.textContent = 'Please enter a valid 5-digit ZIP code.';
        return;
      }

      if (!city || !state) {
        const data = await lookupZip(zip);
        if (data) {
          city = data.city;
          state = data.state;
        }
      }

      if (!name || !address || !city || !state) {
        result.textContent = 'Please fill in all fields.';
        return;
      }

      const entries = loadEntries();
      entries.push({ name, address, city, state, zip, ts: new Date().toISOString() });
      saveEntries(entries);
      renderEntries();

      result.textContent = `Saved locally for ${name}.`;
      form.reset();
    });

    clearBtn.addEventListener('click', () => {
      form.reset();
      result.textContent = '';
    });

    exportBtn.addEventListener('click', () => {
      const data = JSON.stringify(loadEntries(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aitime-submissions.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    clearAllBtn.addEventListener('click', () => {
      if (confirm('Delete all saved entries from this browser?')) {
        localStorage.removeItem(STORAGE_KEY);
        renderEntries();
        result.textContent = '';
      }
    });

    // Render existing on load
    renderEntries();
  </script>
</body>
</html>
